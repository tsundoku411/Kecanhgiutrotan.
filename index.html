<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kẻ Canh Giữ Tro Tàn - Interactive Edition</title>
    <style>
        body { 
            margin: 0; 
            background: #000; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; 
            color: white; 
            overflow: hidden; 
        }

        #game-viewport { 
            width: 100vw; 
            max-width: 500px; 
            height: 100vh; 
            margin: 0 auto; 
            position: relative; 
            background: #111; 
            overflow: hidden; 
            border: 1px solid #333; 
        }

        /* Menu */
        #main-menu { 
            position: absolute; 
            inset: 0; 
            z-index: 500; 
            background: #000; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
        }

        .title-game { 
            font-size: 22px; 
            text-align: center; 
            letter-spacing: 2px; 
            text-shadow: 0 0 10px #ff4500; 
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 12px;
            color: #888;
            margin-bottom: 20px;
            letter-spacing: 1px;
        }

        .btn-start { 
            background: none; 
            border: 1px solid #fff; 
            color: #fff; 
            padding: 12px 30px; 
            cursor: pointer; 
            font-family: inherit;
            transition: all 0.3s;
        }

        .btn-start:hover {
            background: #fff;
            color: #000;
        }

        /* Game Content */
        #game-content { 
            display: none; 
            width: 100%; 
            height: 100%; 
            position: relative; 
        }

        /* Background - 60% phía trên */
        #background { 
            position: absolute; 
            top: 0;
            left: 0;
            right: 0;
            height: 60%;
            background-size: cover; 
            background-position: center; 
            background-repeat: no-repeat;
            filter: brightness(0.6);
            transition: background-image 1s ease-in-out; 
            z-index: 1;
        }

        /* Nhân vật */
        .sprite { 
            position: absolute; 
            bottom: 40%;
            left: 50%; 
            transform: translateX(-50%); 
            width: 40%;
            height: 35%; 
            background-size: contain; 
            background-repeat: no-repeat; 
            background-position: bottom center; 
            transition: all 0.5s ease; 
            opacity: 0; 
            z-index: 10; 
        }

        .speaking { 
            opacity: 1 !important; 
            transform: translateX(-50%) scale(1.05);
            z-index: 20; 
            filter: brightness(1.1); 
        }

        .listening { 
            opacity: 0.3; 
            filter: brightness(0.5); 
        }

        .glow-effect {
            opacity: 1 !important;
            filter: brightness(1.1) drop-shadow(0 0 20px rgba(255,255,255,0.5)) !important;
            transform: translateX(-50%) scale(1.05);
            z-index: 25;
        }

        /* Hộp thoại - 40% phía dưới */
        #ui-box { 
            position: absolute; 
            bottom: 0;
            left: 0;
            right: 0;
            height: 40%;
            background: rgba(0,0,0,0.9);
            border-top: 2px solid #444; 
            padding: 15px 20px;
            z-index: 100; 
            cursor: pointer; 
            box-sizing: border-box; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #nav-bar { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 8px; 
            border-bottom: 1px solid #333; 
            padding-bottom: 5px; 
        }

        #nav-bar button { 
            background: #222; 
            border: 1px solid #444; 
            color: #888; 
            font-size: 11px; 
            cursor: pointer; 
            padding: 4px 10px; 
            font-family: inherit;
        }

        #speaker { 
            color: #d3a13b; 
            font-weight: bold; 
            margin-bottom: 5px; 
            font-size: 14px;
        }

        #text { 
            line-height: 1.6; 
            font-size: 15px; 
            color: #ddd; 
            word-wrap: break-word; 
            overflow: hidden;
            flex: 1;
        }

        /* Choices */
        #choice-container { 
            position: absolute; 
            top: 50%;
            transform: translateY(-50%);
            left: 0; 
            right: 0; 
            display: none; 
            flex-direction: column; 
            gap: 12px; 
            align-items: center; 
            z-index: 200; 
            padding: 0 20px;
        }

        .choice-btn { 
            background: rgba(0,0,0,0.8);
            border: 2px solid #d3a13b; 
            color: white; 
            padding: 15px; 
            width: 100%;
            cursor: pointer; 
            font-family: inherit;
            font-size: 14px;
            transition: all 0.3s;
        }

        .choice-btn:hover {
            background: #d3a13b;
            color: #000;
            transform: scale(1.02);
        }

        /* Credits Screen */
        #credits-screen {
            position: absolute;
            inset: 0;
            background: #000;
            z-index: 3000;
            display: none; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            animation: fadeIn 3s ease-in;
        }

        .ending-title {
            font-size: 20px;
            color: #d3a13b;
            margin-bottom: 20px;
            letter-spacing: 3px;
        }

        .thanks-msg { 
            font-size: 16px; 
            color: #888; 
            letter-spacing: 1px; 
        }

        .author-name { 
            font-size: 26px; 
            color: #d3a13b; 
            font-weight: bold; 
            letter-spacing: 4px; 
            text-shadow: 0 0 15px rgba(211, 161, 59, 0.6);
            margin-top: 10px;
        }

        .replay-btn {
            margin-top: 30px;
            background: none;
            border: 2px solid #d3a13b;
            color: #d3a13b;
            padding: 12px 40px;
            cursor: pointer;
            font-family: inherit;
            font-size: 16px;
            letter-spacing: 2px;
            transition: all 0.3s ease;
        }

        .replay-btn:hover {
            background: #d3a13b;
            color: #000;
            transform: scale(1.05);
        }

        @keyframes fadeIn { 
            from { opacity: 0; } 
            to { opacity: 1; } 
        }

        /* Animations */
        #flash-effect { 
            position: absolute; 
            inset: 0; 
            pointer-events: none; 
            z-index: 1000; 
        }

        .shake-anim { 
            animation: shake-screen 0.3s infinite; 
        }

        @keyframes shake-screen { 
            0% { transform: translate(2px, 2px); } 
            25% { transform: translate(-2px, -2px); } 
            50% { transform: translate(2px, -2px); } 
            100% { transform: translate(0, 0); } 
        }

        .flash-red { 
            animation: flash-red-anim 0.5s; 
        }

        @keyframes flash-red-anim { 
            0% { background: rgba(255,0,0,0); } 
            50% { background: rgba(255,0,0,0.5); } 
            100% { background: rgba(255,0,0,0); } 
        }

        .flash-white { 
            animation: flash-white-anim 0.3s; 
        }

        @keyframes flash-white-anim { 
            0% { background: rgba(255,255,255,0); } 
            50% { background: rgba(255,255,255,0.7); } 
            100% { background: rgba(255,255,255,0); } 
        }

        /* Point indicator (hidden) */
        #points-debug {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            padding: 5px 10px;
            font-size: 10px;
            color: #888;
            z-index: 999;
            display: none; /* Ẩn đi, chỉ debug */
        }
    </style>
</head>
<body>
    <div id="game-viewport">
        <audio id="bgm" loop>
            <source src="https://cdn.discordapp.com/attachments/1467942086421647451/1467942414793707774/medieval-fantasy-music-462199.mp3" type="audio/mpeg">
        </audio>

        <div id="flash-effect"></div>
        <div id="points-debug"></div>

        <div id="main-menu">
            <h1 class="title-game">KẺ CANH GIỮ TRO TÀN</h1>
            <p class="subtitle">Interactive Edition</p>
            <button class="btn-start" onclick="startGame()">BẮT ĐẦU</button>
        </div>

        <div id="game-content">
            <div id="background"></div>
            <div id="char-left" class="sprite"></div>
            <div id="char-right" class="sprite"></div>
            
            <div id="ui-box" onclick="nextStep()">
                <div id="nav-bar">
                    <button onclick="event.stopPropagation(); goBack()">BACK</button>
                    <button onclick="event.stopPropagation(); backToMenu()">MENU</button>
                    <button id="music-btn" onclick="event.stopPropagation(); toggleMusic()">SOUND OFF</button>
                </div>
                <div id="speaker"></div>
                <div id="text"></div>
            </div>
            
            <div id="choice-container"></div>
        </div>

        <div id="credits-screen">
            <div class="ending-title" id="ending-title">KẾT THÚC</div>
            <p class="thanks-msg">Cảm ơn bạn đã chơi</p>
            <p class="author-name">TSUNDOKU411</p>
            <button class="replay-btn" onclick="replayGame()">CHƠI LẠI</button>
        </div>
    </div>

    <script>
        // ASSETS - Dùng ảnh placeholder tạm
        const assets = {
            // Backgrounds - nhiều hơn để tạo cảm giác sống động
            bg_field: "https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=800&h=600&fit=crop", // Cánh đồng
            bg_village: "https://images.unsplash.com/photo-1564760055775-d63b17a55c44?w=800&h=600&fit=crop", // Ngôi làng cổ
            bg_village_night: "https://images.unsplash.com/photo-1533371452382-d45a9da51ad9?w=800&h=600&fit=crop", // Làng đêm
            bg_fog: "https://images.unsplash.com/photo-1487621167305-5d248087c724?w=800&h=600&fit=crop", // Sương mù
            bg_forest: "https://images.unsplash.com/photo-1511497584788-876760111969?w=800&h=600&fit=crop", // Rừng tối
            bg_forest_deep: "https://images.unsplash.com/photo-1542273917363-3b1817f69a2d?w=800&h=600&fit=crop", // Rừng sâu
            bg_battlefield: "https://images.unsplash.com/photo-1516173725245-c19c2e99d615?w=800&h=600&fit=crop", // Chiến trường
            bg_mountain: "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&h=600&fit=crop", // Núi
            bg_mountain_top: "https://images.unsplash.com/photo-1519904981063-b0cf448d479e?w=800&h=600&fit=crop", // Đỉnh núi
            bg_fire: "https://images.unsplash.com/photo-1525551258106-56a4a775803b?w=800&h=600&fit=crop", // Lửa
            bg_ash: "https://images.unsplash.com/photo-1517483000871-1dbf64a6e1c6?w=800&h=600&fit=crop", // Tro tàn
            bg_dark: "https://images.unsplash.com/photo-1419242902214-272b3f66ee7a?w=800&h=600&fit=crop", // Tối đen
            
            // Characters - giữ link của bạn
            bunhin_normal: "https://i.postimg.cc/bwYSt0VQ/Untitled_02_03_2026_12_35_33.png",
            bunhin_sad: "https://i.postimg.cc/bwYSt0VQ/Untitled_02_03_2026_12_35_33.png",
            cobe_normal: "https://i.postimg.cc/13RVq07B/Untitled_02_03_2026_12_43_53.png"
        };

        // HỆ THỐNG ĐIỂM
        let gamePoints = {
            courage: 0,      // Lòng dũng cảm
            understanding: 0, // Thấu hiểu
            sacrifice: 0     // Hy sinh
        };

        // STORY DATA - VIẾT LẠI HOÀN TOÀN
        const storyData = {
            "start": [
                { s: "Dẫn truyện", t: "Ngày xửa ngày xưa...", bg: "bg_field" },
                { s: "Dẫn truyện", t: "Tại một cánh đồng hoang vu, có một gã Bù Nhìn Rơm đứng đơn độc.", bg: "bg_field" },
                { s: "Bù Nhìn", t: "...", imgL: "bunhin_normal" },
                { s: "Dẫn truyện", t: "Gã có vẻ ngoài đáng sợ với đôi mắt là hai hốc tối sâu hoắm và nụ cười thô kệch." },
                { s: "Bù Nhìn", t: "Mặt trời ấm quá... Nhưng ta không cảm thấy gì cả." },
                { s: "Bù Nhìn", t: "Chỉ toàn rơm khô... và sự cô đơn." },
                { s: "Dẫn truyện", t: "Một cơn mưa bất chợt ập xuống. Giọt mưa rơi lên người rơm, tạo âm thanh khô khốc." },
                { s: "Dẫn truyện", t: "Bù Nhìn nhìn xuống. Một mầm cây nhỏ đang run rẩy dưới mưa gió." },
                { s: "Bù Nhìn", t: "Mầm cây này... nếu không có ai che chắn, nó sẽ chết." },
                { s: "LỰA CHỌN", t: "Bù Nhìn sẽ làm gì?", choices: [
                    { text: "Dùng thân mình che mưa cho mầm cây", nextLabel: "protect_plant", points: {sacrifice: 1} },
                    { text: "Đứng yên, quan sát", nextLabel: "watch_plant" }
                ]}
            ],

            "protect_plant": [
                { s: "Bù Nhìn", t: "Ta sẽ... bảo vệ em.", imgL: "bunhin_normal", bg: "bg_field" },
                { s: "Dẫn truyện", t: "Gã cúi người, dùng thân rơm che chắn cho mầm cây khỏi trận mưa dữ dội." },
                { s: "Bù Nhìn", t: "Dù chỉ là cây cỏ... nhưng ta vẫn có thể giúp được ai đó." },
                { s: "Dẫn truyện", t: "Khi mưa tạnh, mầm cây vẫn còn đó, xanh tươi.", effect: "flash" },
                { s: "Bù Nhìn", t: "Tốt rồi... Ít nhất ta còn có thể làm được điều gì đó có ích." },
                { s: "Dẫn truyện", t: "Một con chim sẻ bay đến, đậu lên vai gã." },
                { s: "Bù Nhìn", t: "Ngươi... không sợ ta sao?" },
                { s: "Dẫn truyện", t: "Con chim hót líu lo, rồi bắt đầu làm tổ trên vai rơm." },
                { s: "Bù Nhìn", t: "Được thôi. Ta sẽ đứng yên để ngươi có nhà." },
                { s: "Dẫn truyện", t: "Những ngày trôi qua. Bù Nhìn vẫn đứng đó, giữ cho chim sẻ được an toàn." },
                { s: "Bù Nhìn", t: "Nhưng... ta muốn hơn thế nữa." },
                { s: "Bù Nhìn", t: "Ta muốn được... nói chuyện với ai đó. Như một con người." },
                { s: "LỰA CHỌN 2", t: "Bù Nhìn nhìn về phía ngôi làng xa xa, nơi ánh đèn lung linh.", choices: [
                    { text: "Đến ngôi làng tìm kiếm sự chấp nhận", nextLabel: "go_village", points: {courage: 1} },
                    { text: "Ở lại cánh đồng, không làm phiền ai", nextLabel: "stay_field" }
                ]}
            ],

            "watch_plant": [
                { s: "Bù Nhìn", t: "...", imgL: "bunhin_sad", bg: "bg_field" },
                { s: "Dẫn truyện", t: "Gã đứng im, nhìn mầm cây bị mưa đập tả tơi." },
                { s: "Bù Nhìn", t: "Ta chỉ là một cái bù nhìn... ta không thể làm gì." },
                { s: "Dẫn truyện", t: "Khi mưa tạnh, mầm cây đã héo úa." },
                { s: "Bù Nhìn", t: "Thậm chí một sinh vật nhỏ bé như vậy... ta cũng không cứu được." },
                { s: "Bù Nhìn", t: "Vậy làm sao ta có thể giúp được con người?" },
                { s: "Dẫn truyện", t: "Gã nhìn về phía ngôi làng xa xa." },
                { s: "Bù Nhìn", t: "Nhưng... có lẽ ta nên thử." },
                { s: "LỰA CHỌN", t: "", choices: [
                    { text: "Đến ngôi làng", nextLabel: "go_village" }
                ]}
            ],

            "stay_field": [
                { s: "Bù Nhìn", t: "Không... ta không nên đi.", imgL: "bunhin_sad", bg: "bg_field" },
                { s: "Bù Nhìn", t: "Họ sẽ sợ hãi. Họ sẽ đuổi ta đi." },
                { s: "Dẫn truyện", t: "Gã tiếp tục đứng tại cánh đồng, ngày qua ngày..." },
                { s: "Dẫn truyện", t: "Cho đến một đêm sương mù...", bg: "bg_fog" },
                { s: "Dẫn truyện", t: "Một bóng nhỏ xuất hiện.", glow: true, imgR: "cobe_normal" },
                { s: "Bù Nhìn", t: "Đó là... ai?", imgL: "bunhin_normal" },
                { s: "Dẫn truyện", t: "Đó là một Thây Ma nhỏ tuổi. Nó tiến thẳng đến Bù Nhìn." },
                { s: "LỰA CHỌN", t: "Gã sẽ phản ứng thế nào?", choices: [
                    { text: "Kết bạn với Cô Bé", nextLabel: "friendship", points: {understanding: 2} },
                    { text: "Xua đuổi", nextLabel: "ending_lonely" }
                ]}
            ],

            "go_village": [
                { s: "Bù Nhìn", t: "Ta sẽ thử... đến gần họ.", imgL: "bunhin_normal", bg: "bg_field" },
                { s: "Dẫn truyện", t: "Gã bước những bước chậm chạp về phía ngôi làng.", bg: "bg_village_night" },
                { s: "Bù Nhìn", t: "Ánh đèn đẹp quá... Ấm áp quá..." },
                { s: "Dẫn truyện", t: "Gã nhìn thấy một bà lão đang vất vả gánh củi." },
                { s: "Bù Nhìn", t: "Bà ấy cần giúp đỡ. Ta có thể..." },
                { s: "LỰA CHỌN", t: "", choices: [
                    { text: "Lại gần giúp bà lão", nextLabel: "help_old_woman", points: {courage: 1} },
                    { text: "Chỉ đứng xa quan sát", nextLabel: "watch_from_far" }
                ]}
            ],

            "help_old_woman": [
                { s: "Bù Nhìn", t: "Xin lỗi... Để tôi giúp bà.", imgL: "bunhin_normal", bg: "bg_village_night" },
                { s: "Dẫn truyện", t: "Bà lão quay lại. Nhìn thấy bù nhìn rơm." },
                { s: "Bà lão", t: "QUÁI VẬT!!!", effect: "flash" },
                { s: "Bù Nhìn", t: "K-Không! Tôi chỉ muốn...", imgL: "bunhin_sad" },
                { s: "Dẫn truyện", t: "Tiếng hét vang lên. Dân làng kéo đến." },
                { s: "Người đàn ông", t: "Có quái vật rơm bò vào làng!" },
                { s: "Dẫn truyện", t: "Họ cầm đá, cầm gậy.", effect: "shake" },
                { s: "Bù Nhìn", t: "Xin hãy nghe tôi...", imgL: "bunhin_sad" },
                { s: "Dẫn truyện", t: "Những viên đá bay đến. Rách lớp bao bố. Rơm rạ văng tung tóe." },
                { s: "Bù Nhìn", t: "Đau... Nhưng đau hơn là... họ sợ ta." },
                { s: "Dẫn truyện", t: "Gã chạy trốn về cánh đồng, thân thể rách nát.", bg: "bg_field" },
                { s: "Bù Nhìn", t: "Ta chỉ muốn... giúp đỡ..." },
                { s: "LỰA CHỌN", t: "", choices: [
                    { text: "Tiếp tục", nextLabel: "after_village" }
                ]}
            ],

            "watch_from_far": [
                { s: "Bù Nhìn", t: "Không... Nếu ta lại gần, bà ấy sẽ sợ.", imgL: "bunhin_sad", bg: "bg_village_night" },
                { s: "Dẫn truyện", t: "Gã chỉ đứng trong bóng tối, nhìn." },
                { s: "Bù Nhìn", t: "Họ trông... hạnh phúc quá." },
                { s: "Dẫn truyện", t: "Một đứa trẻ thả con búp bê vải. Nó rơi xuống bùn." },
                { s: "Đứa trẻ", t: "Oa oa! Búp bê!" },
                { s: "Bù Nhìn", t: "Con búp bê... Ta có thể nhặt giúp..." },
                { s: "LỰA CHỌN", t: "", choices: [
                    { text: "Nhặt búp bê đưa cho đứa trẻ", nextLabel: "help_child", points: {courage: 1} },
                    { text: "Quay lưng đi về cánh đồng", nextLabel: "return_field_sad" }
                ]}
            ],

            "help_child": [
                { s: "Bù Nhìn", t: "Của em đây...", imgL: "bunhin_normal", bg: "bg_village_night" },
                { s: "Đứa trẻ", t: "...!!!" },
                { s: "Dẫn truyện", t: "Đứa trẻ nhìn thấy Bù Nhìn. Khóc thét lên.", effect: "flash" },
                { s: "Mẹ đứa trẻ", t: "CON! CHẠY ĐI!" },
                { s: "Bù Nhìn", t: "Tôi không có ý xấu...", imgL: "bunhin_sad" },
                { s: "Dẫn truyện", t: "Dân làng kéo đến. Ném đá đuổi đánh.", effect: "shake" },
                { s: "Bù Nhìn", t: "Tại sao... tại sao họ không hiểu?" },
                { s: "Dẫn truyện", t: "Gã chạy về cánh đồng, tim đau nhói.", bg: "bg_field" },
                { s: "LỰA CHỌN", t: "", choices: [
                    { text: "Tiếp tục", nextLabel: "after_village" }
                ]}
            ],

            "return_field_sad": [
                { s: "Bù Nhìn", t: "Không... Ta không nên.", imgL: "bunhin_sad", bg: "bg_field" },
                { s: "Dẫn truyện", t: "Gã quay lưng, lê bước về cánh đồng." },
                { s: "Bù Nhìn", t: "Dù có cố gắng đến đâu... ta vẫn chỉ là một cái bù nhìn." },
                { s: "LỰA CHỌN", t: "", choices: [
                    { text: "Tiếp tục", nextLabel: "after_village" }
                ]}
            ],

            "after_village": [
                { s: "Dẫn truyện", t: "Trở lại cánh đồng hoang...", bg: "bg_field" },
                { s: "Bù Nhìn", t: "...", imgL: "bunhin_sad" },
                { s: "Dẫn truyện", t: "Bù Nhìn đứng im như một xác khô." },
                { s: "Bù Nhìn", t: "Ta ghét... đôi tay rơm này." },
                { s: "Bù Nhìn", t: "Ta ghét... gương mặt không thể cười này." },
                { s: "Bù Nhìn", t: "Liệu có một phép màu... có thể biến ta thành người?" },
                { s: "Dẫn truyện", t: "Đêm đến. Sương mù dày đặc.", bg: "bg_fog" },
                { s: "Dẫn truyện", t: "Một bóng nhỏ xuất hiện...", glow: true, imgR: "cobe_normal" },
                { s: "Bù Nhìn", t: "Đó là... ai?", imgL: "bunhin_normal" },
                { s: "Dẫn truyện", t: "Một Thây Ma nhỏ tuổi. Làn da xám xịt, đôi mắt vô hồn." },
                { s: "Dẫn truyện", t: "Nó tiến thẳng đến Bù Nhìn, không sợ hãi." },
                { s: "Dẫn truyện", t: "Nó vươn tay chạm vào vạt áo rơm." },
                { s: "Bù Nhìn", t: "Ngươi... không sợ ta?" },
                { s: "Dẫn truyện", t: "Cô bé không trả lời. Nhưng ánh mắt nó... thấu hiểu." },
                { s: "Bù Nhìn", t: "Lần đầu tiên... có ai đó nhìn ta như thế." },
                { s: "LỰA CHỌN", t: "Gã sẽ làm gì?", choices: [
                    { text: "Kết bạn với Cô Bé Thây Ma", nextLabel: "friendship", points: {understanding: 2} },
                    { text: "Xua đuổi sinh vật này", nextLabel: "ending_lonely" }
                ]}
            ],

            "friendship": [
                { s: "Bù Nhìn", t: "Ngươi... muốn ở lại với ta?", imgL: "bunhin_normal", imgR: "cobe_normal", bg: "bg_fog" },
                { s: "Dẫn truyện", t: "Cô bé gật đầu nhẹ." },
                { s: "Bù Nhìn", t: "Một cảm giác kỳ lạ... Như ta đã gặp ngươi từ đâu đó." },
                { s: "Dẫn truyện", t: "Từ đêm đó, họ trở thành bạn của nhau.", bg: "bg_field" },
                { s: "Dẫn truyện", t: "Cô bé không biết nói, nhưng Bù Nhìn hiểu tất cả." },
                { s: "Dẫn truyện", t: "Một ngày nọ, dưới gốc cây già..." },
                { s: "Bù Nhìn", t: "Ngươi có thấy buồn không?" },
                { s: "Dẫn truyện", t: "Cô bé vẽ lên đất. Một hình người nhỏ bé. Rồi những giọt nước." },
                { s: "Bù Nhìn", t: "Ngươi đang khóc... trong bức tranh." },
                { s: "LỰA CHỌN", t: "Bù Nhìn muốn làm gì cho cô bé vui?", choices: [
                    { text: "Tìm hoa dại đẹp nhất tặng cô bé", nextLabel: "give_flowers", points: {understanding: 1, sacrifice: 1} },
                    { text: "Kể chuyện về ước mơ của mình", nextLabel: "tell_dream" }
                ]}
            ],

            "give_flowers": [
                { s: "Bù Nhìn", t: "Chờ ta một chút!", imgL: "bunhin_normal", bg: "bg_field" },
                { s: "Dẫn truyện", t: "Gã đi tìm khắp cánh đồng." },
                { s: "Bù Nhìn", t: "Bông này đẹp... Bông kia cũng xinh..." },
                { s: "Dẫn truyện", t: "Gã trở lại với một bó hoa dại rực rỡ." },
                { s: "Bù Nhìn", t: "Cho ngươi. Cài lên tóc đi." },
                { s: "Dẫn truyện", t: "Cô bé mỉm cười. Nụ cười đầu tiên.", imgR: "cobe_normal", effect: "flash" },
                { s: "Bù Nhìn", t: "Ngươi cười... đẹp quá." },
                { s: "Dẫn truyện", t: "Cô bé vẽ lên đất. Một trái tim." },
                { s: "Bù Nhìn", t: "Ta hiểu rồi. Ta cũng... quý ngươi." },
                { s: "LỰA CHỌN", t: "", choices: [
                    { text: "Tiếp tục", nextLabel: "days_together" }
                ]}
            ],

            "tell_dream": [
                { s: "Bù Nhìn", t: "Ngươi có biết ước mơ của ta không?", imgL: "bunhin_normal", bg: "bg_field" },
                { s: "Dẫn truyện", t: "Cô bé lắng nghe chăm chú." },
                { s: "Bù Nhìn", t: "Ta muốn... có một trái tim nóng hổi." },
                { s: "Bù Nhìn", t: "Có làn da mềm mại. Cảm nhận được nắng ấm." },
                { s: "Bù Nhìn", t: "Thay vì chỉ... rơm khô mục nát này." },
                { s: "Dẫn truyện", t: "Đôi mắt cô bé lóe lên ánh sáng kỳ lạ.", imgR: "cobe_normal" },
                { s: "Bù Nhìn", t: "Ngươi... hiểu ta?" },
                { s: "Dẫn truyện", t: "Cô bé gật đầu. Rồi chỉ vào ngực gã." },
                { s: "Bù Nhìn", t: "Ngực ta? Ở đây không có gì cả mà..." },
                { s: "LỰA CHỌN", t: "", choices: [
                    { text: "Tiếp tục", nextLabel: "days_together" }
                ]}
            ],

            "days_together": [
                { s: "Dẫn truyện", t: "Những ngày trôi qua...", bg: "bg_field" },
                { s: "Dẫn truyện", t: "Bù Nhìn và Cô Bé luôn bên nhau." },
                { s: "Bù Nhìn", t: "Có ngươi ở đây... ta không còn cô đơn nữa.", imgL: "bunhin_normal", imgR: "cobe_normal" },
                { s: "Dẫn truyện", t: "Một ngày nọ, cô bé đột ngột đứng dậy." },
                { s: "Bù Nhìn", t: "Ngươi đi đâu?" },
                { s: "Dẫn truyện", t: "Cô bé chỉ về phía xa xăm, rồi bước đi." },
                { s: "Bù Nhìn", t: "Chờ đã! Đừng bỏ ta lại!" },
                { s: "Dẫn truyện", t: "Nhưng cô bé đã biến mất trong sương mù.", bg: "bg_fog" },
                { s: "Bù Nhìn", t: "Nó đi rồi... Liệu nó có quay lại?", imgL: "bunhin_sad" },
                { s: "Dẫn truyện", t: "Nhiều ngày trôi qua..." },
                { s: "Dẫn truyện", t: "Bù Nhìn đứng chờ. Ngày qua ngày.", bg: "bg_field" },
                { s: "Bù Nhìn", t: "Cầu xin... hãy quay lại..." },
                { s: "Dẫn truyện", t: "Cuối cùng, một đêm trăng khuyết...", bg: "bg_fog" },
                { s: "Dẫn truyện", t: "Cô bé trở lại. Nhưng đầy vết thương.", imgR: "cobe_normal", effect: "flash" },
                { s: "Bù Nhìn", t: "Ngươi bị thương! Ai làm ngươi vậy?!", imgL: "bunhin_sad" },
                { s: "Dẫn truyện", t: "Cô bé mỉm cười. Đưa cho gã một mảnh giấy da cũ." },
                { s: "Bù Nhìn", t: "Đây là... gì?" },
                { s: "Dẫn truyện", t: "Gã mở ra. Trên đó ghi: 'Ngọn Lửa Sự Sống - Đỉnh Núi Phương Bắc'." },
                { s: "Bù Nhìn", t: "Ngọn lửa... có thể biến ta thành người?!" },
                { s: "Dẫn truyện", t: "Cô bé gật đầu. Chỉ vào ngực gã." },
                { s: "Bù Nhìn", t: "Ngươi đã đi tìm điều này... cho ta?" },
                { s: "Bù Nhìn", t: "Tại sao... tại sao ngươi lại tốt với ta đến vậy?" },
                { s: "Dẫn truyện", t: "Cô bé không trả lời. Chỉ nắm tay gã." },
                { s: "LỰA CHỌN", t: "Bù Nhìn quyết định...", choices: [
                    { text: "Đi tìm Ngọn Lửa Sự Sống", nextLabel: "journey_start", points: {courage: 1} },
                    { text: "Từ chối - chỉ muốn ở bên cô bé", nextLabel: "refuse_journey" }
                ]}
            ],

            "refuse_journey": [
                { s: "Bù Nhìn", t: "Không... Ta không cần nữa.", imgL: "bunhin_normal", imgR: "cobe_normal", bg: "bg_field" },
                { s: "Bù Nhìn", t: "Có ngươi ở đây là đủ rồi." },
                { s: "Dẫn truyện", t: "Cô bé lắc đầu. Kéo tay gã." },
                { s: "Bù Nhìn", t: "Ngươi... muốn ta đi?" },
                { s: "Dẫn truyện", t: "Cô bé gật đầu mạnh." },
                { s: "Bù Nhìn", t: "Được rồi... Nếu đó là điều ngươi muốn." },
                { s: "LỰA CHỌN", t: "", choices: [
                    { text: "Bắt đầu hành trình", nextLabel: "journey_start", points: {understanding: 1} }
                ]}
            ],

            "journey_start": [
                { s: "Dẫn truyện", t: "Cuộc hành trình bắt đầu...", bg: "bg_forest" },
                { s: "Bù Nhìn", t: "Ta sẽ cõng ngươi. Ngươi đã bị thương rồi.", imgL: "bunhin_normal", imgR: "cobe_normal" },
                { s: "Dẫn truyện", t: "Cô bé ngồi lên vai gã. Bám chặt vào cổ rơm." },
                { s: "Bù Nhìn", t: "Chúng ta sẽ cùng nhau... đến đỉnh núi." },
                { s: "Dẫn truyện", t: "Họ bước vào rừng sâu.", bg: "bg_forest_deep" },
                { s: "Bù Nhìn", t: "Rừng này... tối quá." },
                { s: "Dẫn truyện", t: "Tiếng gì đó vang lên trong bóng tối." },
                { s: "Bù Nhìn", t: "Có gì đó... đang theo dõi chúng ta." },
                { s: "Dẫn truyện", t: "Đột nhiên - bầu trời tối sầm!", bg: "bg_dark", effect: "flash" },
                { s: "Dẫn truyện", t: "Hàng ngàn con quạ đen kịt lao xuống!" },
                { s: "Bù Nhìn", t: "Lũ Quạ!", imgL: "bunhin_sad" },
                { s: "Dẫn truyện", t: "Chúng mổ vào lớp rơm. Đau đớn cắt xé.", effect: "shake" },
                { s: "LỰA CHỌN", t: "Bù Nhìn phải làm gì?!", choices: [
                    { text: "Ôm chặt cô bé, dùng thân mình che chắn", nextLabel: "protect_girl_crow", points: {sacrifice: 2} },
                    { text: "Đẩy cô bé ra xa, tự mình chiến đấu", nextLabel: "fight_crow_alone", points: {courage: 1} }
                ]}
            ],

            "protect_girl_crow": [
                { s: "Bù Nhìn", t: "Ta sẽ... bảo vệ ngươi!", imgL: "bunhin_normal", imgR: "cobe_normal", bg: "bg_dark" },
                { s: "Dẫn truyện", t: "Gã ôm chặt cô bé vào lòng. Quay lưng với lũ quạ.", effect: "shake" },
                { s: "Bù Nhìn", t: "UGHHH!" },
                { s: "Dẫn truyện", t: "Mỗi cái mổ như dao cắt. Vai gã rách nát." },
                { s: "Bù Nhìn", t: "Đau... Nhưng ta không thể... buông!" },
                { s: "Dẫn truyện", t: "Cô bé run rẩy trong vòng tay gã." },
                { s: "Bù Nhìn", t: "Đừng sợ... Có ta đây..." },
                { s: "Dẫn truyện", t: "Sau một trận chiến dài, lũ quạ cuối cùng bay đi.", effect: "flash" },
                { s: "Bù Nhìn", t: "Chúng đi rồi... Ngươi có sao không?", imgL: "bunhin_sad" },
                { s: "Dẫn truyện", t: "Cô bé lắc đầu. Nhìn gã với ánh mắt lo lắng." },
                { s: "Bù Nhìn", t: "Ta không sao đâu. Chỉ là rơm rạ mà." },
                { s: "Bù Nhìn", t: "Miễn là ngươi an toàn..." },
                { s: "Dẫn truyện", t: "[Một tia ký ức lóe lên...]", effect: "flash_white" },
                { s: "Bù Nhìn", t: "Ugh... Đầu ta..." },
                { s: "FLASHBACK", t: "[Hình ảnh mờ: Tiếng la hét. Ngọn lửa. Ai đó đang chạy...]" },
                { s: "Bù Nhìn", t: "Đó là... gì vậy?" },
                { s: "Dẫn truyện", t: "Nhưng ký ức biến mất nhanh như nó xuất hiện." },
                { s: "LỰA CHỌN", t: "", choices: [
                    { text: "Tiếp tục hành trình", nextLabel: "continue_journey", points: {understanding: 1} }
                ]}
            ],

            "fight_crow_alone": [
                { s: "Bù Nhìn", t: "Ra xa! Ta sẽ đánh đuổi chúng!", imgL: "bunhin_normal", bg: "bg_dark" },
                { s: "Dẫn truyện", t: "Gã đẩy cô bé ra sau. Đối mặt với lũ quạ.", effect: "shake" },
                { s: "Bù Nhìn", t: "Đến đây! Mổ ta đi!" },
                { s: "Dẫn truyện", t: "Gã vung tay, đánh đuổi lũ quạ dữ dội." },
                { s: "Bù Nhìn", t: "Ta sẽ không để chúng... chạm vào ngươi!" },
                { s: "Dẫn truyện", t: "Nhưng có quá nhiều. Vai gã, tay gã đều rách nát." },
                { s: "Bù Nhìn", t: "Chưa đủ... Ta còn chưa ngã!", imgL: "bunhin_sad" },
                { s: "Dẫn truyện", t: "Cuối cùng, lũ quạ bay đi.", effect: "flash" },
                { s: "Bù Nhìn", t: "Ta... thắng rồi..." },
                { s: "Dẫn truyện", t: "Gã quay lại. Cô bé vẫn ổn.", imgR: "cobe_normal" },
                { s: "Bù Nhìn", t: "Tốt rồi... Ngươi không sao." },
                { s: "LỰA CHỌN", t: "", choices: [
                    { text: "Tiếp tục", nextLabel: "continue_journey" }
                ]}
            ],

            "continue_journey": [
                { s: "Dẫn truyện", t: "Họ tiếp tục đi...", bg: "bg_battlefield" },
                { s: "Dẫn truyện", t: "Đến một bãi chiến trường cổ." },
                { s: "Bù Nhìn", t: "Những bộ giáp... Đây từng là chiến trường.", imgL: "bunhin_normal" },
                { s: "Dẫn truyện", t: "Đột nhiên - những bộ giáp rỉ sét đứng dậy!", effect: "shake" },
                { s: "Bù Nhìn", t: "Chúng... còn sống?!" },
                { s: "Dẫn truyện", t: "Những linh hồn chiến binh. Cầm gươm gãy. Tấn công." },
                { s: "Bù Nhìn", t: "Chiến tranh... Gươm đao...", imgL: "bunhin_sad" },
                { s: "FLASHBACK", t: "[Hình ảnh: Gã đang mặc áo giáp... Đồng đội ngã xuống... Máu...]", effect: "flash_white" },
                { s: "Bù Nhìn", t: "Ugh! Lại nữa... Những hình ảnh này..." },
                { s: "Dẫn truyện", t: "Giáp sĩ lao tới!" },
                { s: "LỰA CHỌN", t: "Phải làm gì?!", choices: [
                    { text: "Chiến đấu để bảo vệ cô bé", nextLabel: "fight_warriors", points: {courage: 2, sacrifice: 1} },
                    { text: "Tìm cách né tránh", nextLabel: "dodge_warriors" }
                ]}
            ],

            "fight_warriors": [
                { s: "Bù Nhìn", t: "Ta sẽ chiến đấu!", imgL: "bunhin_normal", imgR: "cobe_normal", bg: "bg_battlefield" },
                { s: "Dẫn truyện", t: "Gã lao vào giữa những bộ giáp.", effect: "shake" },
                { s: "Bù Nhìn", t: "Ta không còn gì để mất!" },
                { s: "Dẫn truyện", t: "Gã dùng thân rơm làm kẹt khớp nối kim loại." },
                { s: "Bù Nhìn", t: "Ngã xuống đi!" },
                { s: "Dẫn truyện", t: "Từng bộ giáp lần lượt sụp đổ." },
                { s: "Bù Nhìn", t: "Ta... làm được!", imgL: "bunhin_normal" },
                { s: "Dẫn truyện", t: "Gã đứng giữa đống sắt vụn. Thở hổn hển." },
                { s: "Bù Nhìn", t: "Có lẽ... ta xứng đáng được làm người." },
                { s: "LỰA CHỌN", t: "", choices: [
                    { text: "Tiếp tục", nextLabel: "reach_mountain" }
                ]}
            ],

            "dodge_warriors": [
                { s: "Bù Nhìn", t: "Ta phải tránh! Không thể chiến đấu!", imgL: "bunhin_sad", bg: "bg_battlefield" },
                { s: "Dẫn truyện", t: "Gã ôm cô bé, chạy quanh những bộ giáp." },
                { s: "Bù Nhìn", t: "Nhanh lên... Nhanh lên!" },
                { s: "Dẫn truyện", t: "Một lưỡi gươm chém tới. Rách vai gã.", effect: "shake" },
                { s: "Bù Nhìn", t: "Agh!" },
                { s: "Dẫn truyện", t: "Nhưng gã không dừng. Chạy thật nhanh." },
                { s: "Dẫn truyện", t: "Cuối cùng, họ thoát khỏi chiến trường.", bg: "bg_forest" },
                { s: "Bù Nhìn", t: "Ta... không dám chiến đấu. Ta hèn nhát quá." },
                { s: "LỰA CHỌN", t: "", choices: [
                    { text: "Tiếp tục", nextLabel: "reach_mountain" }
                ]}
            ],

            "reach_mountain": [
                { s: "Dẫn truyện", t: "Đỉnh núi đã hiện ra...", bg: "bg_mountain" },
                { s: "Bù Nhìn", t: "Kìa! Đó rồi!", imgL: "bunhin_normal", imgR: "cobe_normal" },
                { s: "Dẫn truyện", t: "Một luồng sáng đỏ cam kỳ ảo bao trùm đỉnh núi." },
                { s: "Bù Nhìn", t: "Ngọn lửa... Ngọn Lửa Sự Sống!" },
                { s: "Bù Nhìn", t: "Cuối cùng... ta sẽ được làm người!" },
                { s: "Dẫn truyện", t: "Họ bắt đầu leo lên.", bg: "bg_mountain_top" },
                { s: "Bù Nhìn", t: "Gần rồi... Gần rồi..." },
                { s: "Dẫn truyện", t: "Nhưng đột nhiên - mùi khói!" },
                { s: "Bù Nhìn", t: "Mùi này... Mùi cháy...", imgL: "bunhin_sad" },
                { s: "FLASHBACK", t: "[Hình ảnh: Ngôi làng cháy. Tiếng kêu cứu. Gã đang chạy...]", effect: "flash_white" },
                { s: "Bù Nhìn", t: "Không... KHÔNG!" },
                { s: "Dẫn truyện", t: "Gã run rẩy. Sợ hãi tràn ngập." },
                { s: "Cô bé", t: "...", imgR: "cobe_normal" },
                { s: "Dẫn truyện", t: "Cô bé nhìn gã. Nắm tay gã thật chặt." },
                { s: "Bù Nhìn", t: "Ngươi... tin ta có thể làm được?" },
                { s: "Dẫn truyện", t: "Cô bé gật đầu." },
                { s: "LỰA CHỌN", t: "", choices: [
                    { text: "Vượt qua nỗi sợ, tiếp tục lên đỉnh", nextLabel: "final_scene", points: {courage: 2} }
                ]}
            ],

            "final_scene": [
                { s: "Dẫn truyện", t: "Họ đến đỉnh núi...", bg: "bg_fire" },
                { s: "Dẫn truyện", t: "Ngọn lửa khổng lồ cháy rực trước mặt." },
                { s: "Bù Nhìn", t: "Đây rồi... Ngọn Lửa Sự Sống!", imgL: "bunhin_normal", imgR: "cobe_normal" },
                { s: "Bù Nhìn", t: "Nếu ta bước vào... ta sẽ được làm người!" },
                { s: "Dẫn truyện", t: "Nhưng đột nhiên - cô bé buông tay gã." },
                { s: "Bù Nhìn", t: "Ngươi...?" },
                { s: "Dẫn truyện", t: "Cô bé bước về phía ngọn lửa." },
                { s: "Bù Nhìn", t: "Khoan đã! Ngươi đi đâu?!" },
                { s: "Dẫn truyện", t: "Cô bé quay lại nhìn gã. Mỉm cười buồn.", effect: "flash" },
                { s: "Bù Nhìn", t: "Tại sao ngươi lại cười như vậy...?" },
                { s: "Dẫn truyện", t: "Cô bé chỉ vào ngực gã. Rồi chỉ vào ngực mình." },
                { s: "Bù Nhìn", t: "Ngươi muốn nói... gì?" },
                { s: "Dẫn truyện", t: "Và rồi - cô bé lao mình vào ngọn lửa!", effect: "shake" },
                { s: "Bù Nhìn", t: "KHÔNGGGG!!!", imgL: "bunhin_sad" },
                { s: "Dẫn truyện", t: "Gã chạy tới. Nhưng lửa quá nóng." },
                { s: "LỰA CHỌN CUỐI", t: "Gã phải làm gì?!", choices: [
                    { text: "Nhảy vào lửa cứu cô bé", nextLabel: "ending_redemption", points: {sacrifice: 3, courage: 2} },
                    { text: "Quay lưng bỏ chạy", nextLabel: "ending_truth", points: {} }
                ]}
            ],

            "ending_lonely": [
                { s: "Bù Nhìn", t: "Cút đi! Ta không cần ai!", imgL: "bunhin_sad", bg: "bg_field" },
                { s: "Dẫn truyện", t: "Cô bé lầm lũi rời đi." },
                { s: "Bù Nhìn", t: "Tốt rồi... Ta lại một mình." },
                { s: "Dẫn truyện", t: "Những ngày trôi qua..." },
                { s: "Dẫn truyện", t: "Gã đứng đó. Mãi mãi. Cô độc.", bg: "bg_dark" },
                { s: "Dẫn truyện", t: "Mục nát. Tan rã. Nhưng vẫn còn đó." },
                { s: "Dẫn truyện", t: "Không sống. Không chết." },
                { s: "KẾT THÚC", t: "ENDING: Cô Đơn Mãi Mãi", ending: "lonely" }
            ],

            "ending_redemption": [
                { s: "Bù Nhìn", t: "TA SẼ CỨU NGƯƠI!", imgL: "bunhin_normal", bg: "bg_fire" },
                { s: "Dẫn truyện", t: "Gã lao vào ngọn lửa!", effect: "flash" },
                { s: "Bù Nhìn", t: "UGHHHH!!!" },
                { s: "Dẫn truyện", t: "Lửa thiêu đốt. Đau đớn không thể tả.", effect: "shake" },
                { s: "Bù Nhìn", t: "Đau... Nhưng ta phải... cứu ngươi!" },
                { s: "Dẫn truyện", t: "Gã tìm thấy cô bé. Ôm chặt lấy." },
                { s: "Bù Nhìn", t: "Ta đã tìm thấy ngươi!" },
                { s: "Dẫn truyện", t: "Nhưng cô bé đang tan biến..." },
                { s: "Cô bé", t: "..." },
                { s: "Dẫn truyện", t: "Cô bé đặt tay lên ngực gã. Nơi trái tim lẽ ra phải có." },
                { s: "FLASHBACK CUỐI", t: "[Tất cả hiện ra: Gã là lính. Phản bội làng. Lửa cháy. Cô bé chết. Trái tim gã rơi ra...]", effect: "flash_white" },
                { s: "Bù Nhìn", t: "Ta... nhớ ra rồi..." },
                { s: "Bù Nhìn", t: "Ngươi là... nạn nhân của ta..." },
                { s: "Bù Nhìn", t: "Trái tim ta... đang trong lồng ngực ngươi..." },
                { s: "Cô bé", t: "[Gật đầu. Mỉm cười tha thứ]", imgR: "cobe_normal" },
                { s: "Bù Nhìn", t: "Xin lỗi... XIN LỖI NGƯƠI!!!" },
                { s: "Dẫn truyện", t: "Ngọn lửa bao trùm cả hai.", effect: "flash_white" },
                { s: "Dẫn truyện", t: "Khi lửa tắt...", bg: "bg_ash" },
                { s: "Dẫn truyện", t: "Chỉ còn tro tàn." },
                { s: "Dẫn truyện", t: "Nhưng trong đống tro... có hai linh hồn đang nắm tay nhau." },
                { s: "Dẫn truyện", t: "Cùng nhau bay lên trời cao." },
                { s: "Dẫn truyện", t: "Được giải thoát." },
                { s: "KẾT THÚC", t: "ENDING: Cứu Rỗi", ending: "redemption" }
            ],

            "ending_truth": [
                { s: "Bù Nhìn", t: "T-Ta...", imgL: "bunhin_sad", bg: "bg_fire" },
                { s: "Bù Nhìn", t: "Ta... sợ..." },
                { s: "Dẫn truyện", t: "Gã quay lưng. Chạy.", effect: "shake" },
                { s: "Bù Nhìn", t: "TA KHÔNG DÁM!!!" },
                { s: "Dẫn truyện", t: "Nhưng chỉ chạy được vài bước..." },
                { s: "Dẫn truyện", t: "Từ ngực gã - đau nhói!", effect: "flash_white" },
                { s: "Bù Nhìn", t: "UGHHH!!!" },
                { s: "Dẫn truyện", t: "Gã quay lại nhìn." },
                { s: "Dẫn truyện", t: "Cô bé đang đứng trong lửa. Nhìn gã.", imgR: "cobe_normal" },
                { s: "Cô bé", t: "[Ánh mắt buồn bã và đau đớn]" },
                { s: "Bù Nhìn", t: "Tại sao... ngươi nhìn ta như vậy..." },
                { s: "FLASHBACK", t: "[Hình ảnh: Năm xưa. Gã mặc giáp. Bán đứng làng...]", effect: "flash_white" },
                { s: "Bù Nhìn", t: "Không... Đó không phải ta..." },
                { s: "FLASHBACK", t: "[Ngọn lửa thiêu rụi làng. Tiếng kêu cứu...]" },
                { s: "Bù Nhìn", t: "Không... KHÔNG..." },
                { s: "FLASHBACK", t: "[Gã hoảng loạn. Quấn rơm quanh người. Trái tim rơi ra...]" },
                { s: "Bù Nhìn", t: "Ta... nhớ ra rồi..." },
                { s: "FLASHBACK", t: "[Cô bé chạy trong lửa. Bị bắn. Ngã xuống. Tay nắm trái tim gã...]" },
                { s: "Bù Nhìn", t: "NGƯƠI LÀ...", imgL: "bunhin_sad" },
                { s: "Bù Nhìn", t: "Nạn nhân của ta..." },
                { s: "Dẫn truyện", t: "Cô bé mỉm cười buồn. Trái tim trong lồng ngực nó bắt đầu cháy." },
                { s: "Bù Nhìn", t: "Ngươi... mang trái tim ta suốt bao năm..." },
                { s: "Bù Nhìn", t: "Chỉ để dẫn ta đến đây..." },
                { s: "Bù Nhìn", t: "Và ta... lại phản bội ngươi lần nữa..." },
                { s: "Dẫn truyện", t: "Cô bé tan biến trong ngọn lửa. Trái tim cháy thành tro.", effect: "flash" },
                { s: "Bù Nhìn", t: "KHÔNGGGG!!!" },
                { s: "Dẫn truyện", t: "Tiếng 'rắc' khô khốc vang lên từ ngực gã." },
                { s: "Bù Nhìn", t: "Cơ hội cuối cùng... vỡ tan rồi...", bg: "bg_ash" },
                { s: "Dẫn truyện", t: "Gã quỳ xuống. Bới tìm trong tro tàn." },
                { s: "Bù Nhìn", t: "Còn gì không... Còn gì của ngươi không..." },
                { s: "Dẫn truyện", t: "Nhưng gió đã thổi bay tất cả." },
                { s: "Bù Nhìn", t: "Ta giết ngươi hai lần..." },
                { s: "Bù Nhìn", t: "Một lần bằng sự phản bội..." },
                { s: "Bù Nhìn", t: "Một lần bằng sự hèn nhát..." },
                { s: "Dẫn truyện", t: "Gã trở về cánh đồng. Đứng đó.", bg: "bg_field" },
                { s: "Dẫn truyện", t: "Cô đơn đến điên loạn." },
                { s: "Dẫn truyện", t: "Nhưng sợ chết đến mức không dám tự vẫn." },
                { s: "Dẫn truyện", t: "Không sống. Không chết." },
                { s: "Dẫn truyện", t: "Mãi mãi." },
                { s: "KẾT THÚC", t: "ENDING: Hèn Nhát Vĩnh Cửu", ending: "coward" }
            ]
        };

        // GAME STATE
        let currentLabel = "start", currentIndex = 0, history = [];
        let isTyping = false, typeInterval, currentFullText = "";

        function updatePointsDebug() {
            const debug = document.getElementById("points-debug");
            debug.textContent = `C:${gamePoints.courage} U:${gamePoints.understanding} S:${gamePoints.sacrifice}`;
        }

        function startGame() {
            const music = document.getElementById("bgm");
            music.volume = 0.4;
            music.play().catch(e => console.log("Nhạc bị chặn"));

            document.getElementById("main-menu").style.display = "none";
            document.getElementById("game-content").style.display = "block";
            currentLabel = "start";
            currentIndex = 0;
            history = [];
            gamePoints = {courage: 0, understanding: 0, sacrifice: 0};
            render(false);
        }

        function toggleMusic() {
            const music = document.getElementById("bgm");
            const btn = document.getElementById("music-btn");
            if (music.paused) {
                music.play();
                btn.innerText = "SOUND OFF";
            } else {
                music.pause();
                btn.innerText = "SOUND ON";
            }
        }

        function backToMenu() {
            const music = document.getElementById("bgm");
            music.pause();
            music.currentTime = 0;
            document.getElementById("main-menu").style.display = "flex";
            document.getElementById("game-content").style.display = "none";
            document.getElementById("credits-screen").style.display = "none";
            clearInterval(typeInterval);
        }

        function replayGame() {
            document.getElementById("credits-screen").style.display = "none";
            currentLabel = "start";
            currentIndex = 0;
            history = [];
            gamePoints = {courage: 0, understanding: 0, sacrifice: 0};
            clearInterval(typeInterval);
            document.getElementById("game-content").style.display = "block";
            render(false);
            
            const music = document.getElementById("bgm");
            if (music.paused) {
                music.currentTime = 0;
                music.play().catch(e => console.log("Nhạc bị chặn"));
            }
        }

        function render(skipType = false) {
            const step = storyData[currentLabel][currentIndex];
            const textElement = document.getElementById("text");
            const container = document.getElementById("choice-container");
            const viewport = document.getElementById("game-viewport");
            const flash = document.getElementById("flash-effect");

            container.style.display = "none";
            clearInterval(typeInterval);
            currentFullText = step.t;

            viewport.className = step.effect === "shake" ? "shake-anim" : "";
            if (step.effect === "flash") flash.className = "flash-red";
            else if (step.effect === "flash_white") flash.className = "flash-white";
            else flash.className = "";

            document.getElementById("speaker").innerText = (step.s.includes("Dẫn truyện") || step.choices || step.s === "KẾT THÚC" || step.s === "FLASHBACK") ? "" : step.s;

            if (skipType) {
                textElement.innerText = currentFullText;
                isTyping = false;
                if (step.choices) showChoices(step.choices);
            } else {
                textElement.innerText = "";
                isTyping = true;
                let charIndex = 0;
                typeInterval = setInterval(() => {
                    if (charIndex < currentFullText.length) {
                        textElement.innerText += currentFullText.charAt(charIndex);
                        charIndex++;
                    } else {
                        finishTyping();
                    }
                }, 25);
            }

            if (step.bg) {
                const bgElement = document.getElementById("background");
                bgElement.style.backgroundImage = `url('${assets[step.bg]}')`;
            }
            if (step.imgL && assets[step.imgL]) document.getElementById("char-left").style.backgroundImage = `url('${assets[step.imgL]}')`;
            if (step.imgR && assets[step.imgR]) document.getElementById("char-right").style.backgroundImage = `url('${assets[step.imgR]}')`;

            const speaker = step.s.toLowerCase();
            const charLeft = document.getElementById("char-left");
            const charRight = document.getElementById("char-right");

            charLeft.className = "sprite listening";
            charRight.className = "sprite listening";

            if (speaker === "bù nhìn") {
                charLeft.className = "sprite speaking";
            } else if (speaker === "cô bé") {
                charRight.className = "sprite speaking";
            }

            if (step.glow) {
                charRight.className = "sprite speaking glow-effect";
            } else {
                charRight.classList.remove("glow-effect");
            }

            if (step.s === "KẾT THÚC") {
                setTimeout(() => {
                    const credits = document.getElementById("credits-screen");
                    const endingTitle = document.getElementById("ending-title");
                    
                    if (step.ending === "lonely") {
                        endingTitle.textContent = "CÔ ĐƠN MÃI MÃI";
                    } else if (step.ending === "redemption") {
                        endingTitle.textContent = "CỨU RỖI";
                    } else if (step.ending === "coward") {
                        endingTitle.textContent = "HÈN NHÁT VĨNH CỬU";
                    }
                    
                    if (credits) credits.style.display = "flex";
                }, 2500);
            }

            updatePointsDebug();
        }

        function finishTyping() {
            clearInterval(typeInterval);
            document.getElementById("text").innerText = currentFullText;
            isTyping = false;
            const step = storyData[currentLabel][currentIndex];
            if (step.choices) showChoices(step.choices);
        }

        function showChoices(choices) {
            const container = document.getElementById("choice-container");
            container.innerHTML = "";
            container.style.display = "flex";
            
            choices.forEach(ch => {
                const btn = document.createElement("button");
                btn.className = "choice-btn";
                btn.innerText = ch.text;
                btn.onclick = (e) => {
                    e.stopPropagation();
                    
                    // Cộng điểm
                    if (ch.points) {
                        if (ch.points.courage) gamePoints.courage += ch.points.courage;
                        if (ch.points.understanding) gamePoints.understanding += ch.points.understanding;
                        if (ch.points.sacrifice) gamePoints.sacrifice += ch.points.sacrifice;
                    }
                    
                    history.push({label: currentLabel, index: currentIndex});
                    currentLabel = ch.nextLabel;
                    currentIndex = 0;
                    render(false);
                };
                container.appendChild(btn);
            });
        }

        function nextStep() {
            if (isTyping) {
                finishTyping();
                return;
            }
            const path = storyData[currentLabel];
            if (path[currentIndex].choices) return;
            if (currentIndex < path.length - 1) {
                history.push({label: currentLabel, index: currentIndex});
                currentIndex++;
                render(false);
            }
        }

        function goBack() {
            if (history.length > 0) {
                clearInterval(typeInterval);
                const last = history.pop();
                currentLabel = last.label;
                currentIndex = last.index;
                render(true);
            }
        }
    </script>
</body>
</html>
